<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flat Lottery - Apply</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="script.js"></script>
</head>
<body>
    <div class="container">
        <h1>Flat Lottery System</h1>
        
        <div id="login-section">
            <h2>Login with Email OTP</h2>
            <input type="email" id="email-input" placeholder="Enter your email">
            <button onclick="handleSendOtp()">Send OTP</button>
            
            <div id="otp-section" class="hidden">
                <input type="text" id="otp-input" placeholder="Enter OTP">
                <button onclick="handleVerifyOtp()">Verify OTP</button>
            </div>
            <div id="login-status"></div>
        </div>

        <div id="app-section" class="hidden">
            <h2>Application Form</h2>
            <input type="text" id="name-input" placeholder="Full Name">
            <input type="text" id="mobile-input" placeholder="Mobile Number">
            <select id="category-input">
                <option value="General">General</option>
                <option value="SC">SC</option>
                <option value="ST">ST</option>
            </select>
            <button onclick="handleSubmitApplication()">Submit Application</button>
            <div id="app-status"></div>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <script>
        let currentEmail = '';

        async function handleSendOtp() {
            const email = document.getElementById('email-input').value.trim();
            if (!email) return alert('Enter email');
            try {
                await sendOtp(email);
                currentEmail = email;
                document.getElementById('otp-section').classList.remove('hidden');
                document.getElementById('login-status').innerHTML = '<span class="status-success">OTP sent to your email</span>';
            } catch (e) {
                document.getElementById('login-status').innerHTML = `<span class="status-error">${e.message}</span>`;
            }
        }

        async function handleVerifyOtp() {
            const token = document.getElementById('otp-input').value.trim();
            if (!token) return alert('Enter OTP');
            try {
                await verifyOtp(currentEmail, token);
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('app-status').innerHTML = '<span class="status-success">Logged in successfully</span>';
            } catch (e) {
                document.getElementById('login-status').innerHTML = `<span class="status-error">${e.message}</span>`;
            }
        }

        async function handleSubmitApplication() {
            const name = document.getElementById('name-input').value.trim();
            const mobile = document.getElementById('mobile-input').value.trim();
            const category = document.getElementById('category-input').value;
            if (!name || !mobile) return alert('Fill all fields');
            try {
                const msg = await submitApplication(name, mobile, category);
                document.getElementById('app-status').innerHTML = `<span class="status-success">${msg}</span>`;
            } catch (e) {
                document.getElementById('app-status').innerHTML = `<span class="status-error">${e.message}</span>`;
            }
        }

        // Check if already logged in on load
        window.onload = async () => {
            const user = await getCurrentUser();
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
